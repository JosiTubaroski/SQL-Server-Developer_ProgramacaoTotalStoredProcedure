/*
Passando uma tabela como parâmetro

Um dos recursos interessantes na passagem de parâmetros, é a necessidade
de passar um conjunto de dados (um dataset por exemplo) para a procedure.

O SQL Server tem o conceito de Table-Valued Parameters que permite
você passar como parâmetro, uma tabela!!

Com isso, voce evita de criar tabelas temporárias ou mesmo criar dezenas 
parâmetros na sua procedure.

Mas temos que utilizar junto outros conceitos como o tipo de dados tabela,
por exemplo.

Neste link temos mais informações sobre parâmetro como valor de tabela. 
*/


/*
Para fazer uma demonstração, vamos considerar o seguinte cenário.

A atualização de preços e quantidade do estoque de livros são preparados
em formato de planilhas e distribuidos para as lojas atualizarem os dados.

Esse formato contém o ID do Livro, a quantidade que será adicionda no estoque
e o valor atualizado dos produtos.

Depois dos dados importados, ele deve ser atualizados na tabela
tRELEstoque com a seguinte regra:

1. A quantidade enviada será adicionada na quantidade atual.
2. O valor dos livros será atualizada no valor atual 

Mas o processo de atualização deve ser realizado via Store Procedure. 

*/

use eBook
go

Create Table tTMPAtualizaEstoque 
(
   iIDLivro int not null,
   nQuantidade  int not null  ,
   mValor smallmoney not null 
)
go

insert into  tTMPAtualizaEstoque
values (106,14,115.06),
       (159,18,130.00),
       (173,15,117.78),
       (176,12,119.14),
       (203,8,30.87),
       (253,18,39.02),
       (270,5,87.91),
       (429,14,40.38),
       (436,3,87.91),
       (491,5,5.07),
       (550,70,67.54),
       (560,38,18.65),
       (607,15,67.54),
       (675,12,26.80),
       (738,4,39.02),
       (773,6,5.07),
       (828,9,44.45),
       (852,8,36.31),
       (861,18,132.72),
       (869,26,49.88),
       (871,5,124.57),
       (880,21,89.26),
       (930,9,10.51),
       (991,4,59.39),
       (1098,3,78.40),
       (1147,18,13.22),
       (1151,92,72.97),
       (1176,3,21.37),
       (1233,18,34.95),
       (1249,14,47.17),
       (1342,21,9.15),
       (1384,4,89.26),
       (1403,10,110.99),
       (1406,3,55.32),
       (1430,36,116.42),
       (1456,42,127.28),
       (1513,14,112.35),
       (1526,40,30.87),
       (1604,14,60.75),
       (1607,38,116.42),
       (1683,26,17.29),
       (1702,18,136.79),
       (1794,9,78.40),
       (1806,7,28.16),
       (1813,14,120.50),
       (1817,77,62.11),
       (1876,3,115.06),
       (1894,14,134.07),
       (1919,54,131.36),
       (1990,16,81.12),
       (2059,14,70.25),
       (2096,9,36.31),
       (2098,6,26.80),
       (2105,21,101.48),
       (2108,8,68.90),
       (2132,12,98.77),
       (2184,4,78.40),
       (2194,10,117.78),
       (2227,3,58.03),
       (2230,38,32.23),
       (2232,4,116.42),
       (2356,24,30.87),
       (2384,9,51.24),
       (2406,3,30.87),
       (2563,13,60.75),
       (2614,21,32.23),
       (2637,16,127.28),
       (2698,8,83.83),
       (2818,24,79.76),
       (2839,12,58.03),
       (2867,27,125.93),
       (2877,3,108.27),
       (2894,3,55.32),
       (2900,44,91.98),
       (2909,9,47.17),
       (2933,31,26.80),
       (2945,6,108.27),
       (2985,21,56.67),
       (3034,3,132.72),
       (3070,12,45.81),
       (3121,39,132.72),
       (3235,6,82.47),
       (3259,3,14.58),
       (3295,18,134.07),
       (3317,21,39.02),
       (3337,10,127.28),
       (3349,15,30.87),
       (3351,6,39.02),
       (3378,13,116.42),
       (3391,2,109.63),
       (3396,22,87.91),
       (3450,10,13.22),
       (3462,24,86.55),
       (3506,6,45.81),
       (3530,4,63.46),
       (3609,9,37.66),
       (3724,4,104.20),
       (3730,21,62.11),
       (3776,9,26.80),
       (3849,24,47.17),
       (3860,6,13.22),
       (3870,12,71.61),
       (3887,9,52.60),
       (3925,31,14.58),
       (3975,18,134.07),
       (4007,10,119.14),
       (4085,3,70.25),
       (4134,6,13.22),
       (4145,3,29.52),
       (4181,27,90.62),
       (4225,24,17.29),
       (4251,12,98.77),
       (4292,4,78.40),
       (4305,3,48.53),
       (4312,3,123.21),
       (4345,14,25.44),
       (4374,18,125.93),
       (4411,8,90.62),
       (4502,26,132.72),
       (4514,24,41.74),
       (4551,9,72.97),
       (4600,6,5.07),
       (4611,21,125.93),
       (4622,12,79.76),
       (4624,29,59.39),
       (4649,27,113.71),
       (4668,4,89.26),
       (4703,5,15.94),
       (4718,12,134.07),
       (4745,33,134.07),
       (4784,4,60.75),
       (4854,19,115.06),
       (4867,4,49.88),
       (4910,16,6.43),
       (4918,5,121.85),
       (4924,58,79.76),
       (4977,19,68.90),
       (5012,4,37.66),
       (5024,6,127.28),
       (5089,27,60.75),
       (5091,5,9.15),
       (5137,15,51.24),
       (5173,6,56.67),
       (5231,16,10.51),
       (5251,47,71.61),
       (5264,6,82.47),
       (5290,8,47.17),
       (5327,63,132.72),
       (5388,8,20.01),
       (5399,18,79.76),
       (5435,12,120.50),
       (5446,12,71.61),
       (5458,24,6.43),
       (5481,18,100.13),
       (5567,46,116.42),
       (5629,24,110.99),
       (5652,3,120.50),
       (5678,12,55.32),
       (5682,10,113.71),
       (5716,15,56.67),
       (5760,21,55.32),
       (5772,18,7.79),
       (5817,8,52.60),
       (5819,18,33.59),
       (5820,3,100.13),
       (5866,12,36.31),
       (5869,13,116.42),
       (5899,18,40.38),
       (6003,4,21.37),
       (6039,21,47.17),
       (6055,24,128.64),
       (6106,10,25.44),
       (6115,34,104.20),
       (6126,33,58.03),
       (6173,18,120.50),
       (6187,10,45.81),
       (6193,6,15.94),
       (6244,5,14.58),
       (6281,13,81.12),
       (6328,21,60.75),
       (6356,4,47.17),
       (6376,9,11.86),
       (6454,4,119.14),
       (6455,10,123.21),
       (6515,6,85.19),
       (6516,6,9.15),
       (6521,9,112.35),
       (6544,11,115.06),
       (6631,29,110.99),
       (6637,6,72.97),
       (6647,7,134.07),
       (6668,3,55.32),
       (6700,6,101.48),
       (6733,38,67.54),
       (6744,5,64.82),
       (6779,21,64.82),
       (6870,33,108.27),
       (6899,6,47.17),
       (6937,57,62.11),
       (7001,7,116.42),
       (7012,3,25.44),
       (7031,24,49.88),
       (7146,4,115.06),
       (7170,9,100.13),
       (7192,12,110.99),
       (7241,6,119.14),
       (7275,3,41.74),
       (7287,6,13.22),
       (7325,14,94.70),
       (7371,51,94.70),
       (7394,12,64.82),
       (7403,4,115.06),
       (7499,4,110.99),
       (7507,12,105.56),
       (7518,22,83.83),
       (7523,8,72.97),
       (7541,36,25.44),
       (7606,30,87.91),
       (7613,31,125.93),
       (7694,4,34.95),
       (7704,13,101.48),
       (7760,14,47.17),
       (7770,14,119.14),
       (7784,8,119.14),
       (7794,3,81.12),
       (7826,3,100.13),
       (7827,6,47.17),
       (7856,16,47.17),
       (7939,9,83.83),
       (7951,39,20.01),
       (7962,37,56.67),
       (7984,6,70.25),
       (8000,8,10.51),
       (8003,6,28.16),
       (8038,12,10.51),
       (8145,8,112.35),
       (8150,12,77.04),
       (8151,14,41.74),
       (8181,5,91.98),
       (8211,6,28.16),
       (8225,4,39.02),
       (8271,18,26.80),
       (8375,10,51.24),
       (8389,24,82.47),
       (8416,3,52.60),
       (8422,6,20.01),
       (8426,9,47.17),
       (8435,10,5.07),
       (8458,15,102.84),
       (8459,27,43.09),
       (8462,16,113.71),
       (8489,4,33.59),
       (8493,15,108.27),
       (8497,9,26.80),
       (8550,12,66.18),
       (8578,3,130.00),
       (8588,12,14.58),
       (8600,3,36.31),
       (8639,18,48.53),
       (8650,8,94.70),
       (8689,18,93.34),
       (8697,9,48.53),
       (8723,20,6.43),
       (8755,44,29.52),
       (8808,3,41.74),
       (8850,6,98.77),
       (8856,39,72.97),
       (8868,3,45.81),
       (8872,12,97.41),
       (8880,60,11.86),
       (8881,18,82.47),
       (8919,4,25.44),
       (8920,9,25.44),
       (9001,12,74.33),
       (9013,56,3.72),
       (9119,6,93.34),
       (9142,8,67.54),
       (9145,12,127.28),
       (9155,4,75.68),
       (9233,43,90.62),
       (9256,18,115.06),
       (9361,21,9.15),
       (9368,3,56.67),
       (9372,24,105.56),
       (9387,21,36.31),
       (9394,14,22.73),
       (9402,8,98.77),
       (9416,43,90.62),
       (9432,5,113.71),
       (9462,3,32.23),
       (9501,6,125.93),
       (9526,6,132.72),
       (9555,4,68.90),
       (9601,8,66.18),
       (9659,10,91.98),
       (9698,12,18.65),
       (9780,5,108.27),
       (9796,30,68.90),
       (9805,6,41.74),
       (9865,18,120.50),
       (9912,6,63.46),
       (9934,6,72.97),
       (9943,6,5.07),
       (9966,21,109.63),
       (9988,30,66.18),
       (9996,4,85.19),
       (10014,8,51.24),
       (10017,55,39.02),
       (10174,26,94.70),
       (10179,24,36.31),
       (10192,24,37.66),
       (10210,47,17.29),
       (10287,12,87.91),
       (10306,8,34.95),
       (10315,9,79.76),
       (10333,5,13.22),
       (10392,6,14.58),
       (10481,10,131.36),
       (10535,15,32.23),
       (10540,6,128.64),
       (10565,29,66.18),
       (10566,10,127.28),
       (10581,62,123.21),
       (10620,12,131.36),
       (10665,18,58.03),
       (10676,12,117.78),
       (10694,47,113.71),
       (10722,8,100.13),
       (10821,30,104.20),
       (10844,49,67.54),
       (10848,54,86.55),
       (10973,33,131.36),
       (11007,10,56.67),
       (11096,9,44.45),
       (11125,6,67.54),
       (11141,22,75.68),
       (11172,4,52.60),
       (11236,17,59.39),
       (11285,10,108.27),
       (11324,15,104.20),
       (11335,30,67.54),
       (11340,27,86.55),
       (11391,44,108.27),
       (11410,6,105.56),
       (11425,4,117.78),
       (11426,3,43.09),
       (11474,4,108.27),
       (11477,6,134.07),
       (11499,5,52.60),
       (11516,4,74.33),
       (11886,16,28.16),
       (11912,55,104.20),
       (11954,58,87.91),
       (11983,4,14.58),
       (11990,12,108.27),
       (12024,29,91.98),
       (12076,6,66.18),
       (12121,7,123.21),
       (12161,51,117.78),
       (12192,12,112.35),
       (12209,8,94.70),
       (12216,15,10.51),
       (12219,16,44.45),
       (12246,4,85.19),
       (12276,35,36.31),
       (12292,7,112.35),
       (12369,12,18.65),
       (12387,24,51.24),
       (12439,12,101.48),
       (12445,16,102.84),
       (12492,6,25.44),
       (12560,7,13.22),
       (12588,4,53.96),
       (12594,20,106.92),
       (12775,29,110.99),
       (12808,19,22.73),
       (12812,21,10.51),
       (12843,15,83.83),
       (12863,16,128.64),
       (12982,6,135.43),
       (13049,4,10.51),
       (13060,27,125.93),
       (13078,22,75.68),
       (13086,7,68.90),
       (13117,21,34.95),
       (13132,14,17.29),
       (13145,10,120.50),
       (13177,3,21.37),
       (13247,30,83.83),
       (13253,9,98.77),
       (13264,4,55.32),
       (13309,4,77.04),
       (13351,6,48.53),
       (13360,6,116.42),
       (13379,4,24.08),
       (13392,31,82.47),
       (13412,6,98.77),
       (13424,55,89.26),
       (13459,10,9.15),
       (13504,3,36.31),
       (13523,8,119.14),
       (13589,9,77.04),
       (13594,9,9.15),
       (13637,15,21.37),
       (13664,21,67.54),
       (13727,14,135.43),
       (13746,13,115.06),
       (13775,4,36.31),
       (13806,32,106.92),
       (13820,9,28.16),
       (13830,4,113.71),
       (13848,30,71.61),
       (13871,7,9.15),
       (13905,12,71.61),
       (14116,3,108.27),
       (14180,21,115.06),
       (14360,8,102.84),
       (14362,9,115.06),
       (14392,4,97.41),
       (14395,33,112.35),
       (14405,24,36.31),
       (14427,15,74.33),
       (14430,4,83.83),
       (14461,28,9.15),
       (14464,15,53.96),
       (14486,15,82.47),
       (14513,12,33.59),
       (14553,10,34.95),
       (14557,49,128.64),
       (14588,6,64.82),
       (14599,9,83.83),
       (14619,12,72.97),
       (14695,6,130.00),
       (14716,3,43.09),
       (14737,14,105.56),
       (14738,12,119.14),
       (14815,30,124.57),
       (14848,6,49.88),
       (14849,16,130.00),
       (14960,3,108.27),
       (14963,15,55.32),
       (14968,18,66.18),
       (14984,15,29.52),
       (14986,18,32.23),
       (15023,9,113.71),
       (15049,24,3.72),
       (15052,20,6.43),
       (15076,21,15.94),
       (15079,6,58.03),
       (15123,12,36.31),
       (15154,12,3.72),
       (15249,41,102.84),
       (15292,4,30.87),
       (15442,3,18.65),
       (15450,8,67.54),
       (15478,3,130.00),
       (15506,15,78.40),
       (15516,15,112.35),
       (15520,16,37.66),
       (15563,20,45.81),
       (15569,27,135.43),
       (15600,16,104.20),
       (15638,14,29.52),
       (15645,3,45.81),
       (15705,18,120.50),
       (15713,16,135.43),
       (15737,27,127.28),
       (15742,6,66.18),
       (15757,9,72.97),
       (15823,11,52.60),
       (15855,15,115.06),
       (15890,4,22.73),
       (15899,3,41.74),
       (15951,3,11.86),
       (15994,12,47.17),
       (15999,15,112.35),
       (16256,15,28.16),
       (16285,32,127.28),
       (16291,36,113.71),
       (16292,12,104.20),
       (16337,3,6.43),
       (16358,15,66.18),
       (16431,3,37.66),
       (16436,16,105.56),
       (16502,8,7.79),
       (16549,5,32.23),
       (16551,14,128.64),
       (16598,10,104.20),
       (16604,18,102.84),
       (16614,10,83.83),
       (16645,8,91.98),
       (16687,3,79.76),
       (16724,21,105.56),
       (16754,16,22.73),
       (16774,5,5.07),
       (16802,18,59.39),
       (16820,24,60.75),
       (16991,16,119.14),
       (17110,6,108.27),
       (17188,4,101.48),
       (17248,4,21.37),
       (17278,25,124.57),
       (17279,3,32.23),
       (17330,9,97.41),
       (17348,57,25.44),
       (17382,14,29.52),
       (17428,5,14.58),
       (17435,10,33.59),
       (17456,47,74.33),
       (17545,21,44.45),
       (17547,10,20.01),
       (17566,12,22.73),
       (17587,6,39.02),
       (17676,5,6.43),
       (17697,47,55.32),
       (17740,14,24.08),
       (17779,14,113.71),
       (17813,15,86.55),
       (17840,21,68.90),
       (17844,12,101.48),
       (17855,8,25.44),
       (17867,30,10.51),
       (17996,3,87.91),
       (18140,9,3.72),
       (18143,3,89.26),
       (18207,65,10.51),
       (18229,63,15.94),
       (18246,6,130.00),
       (18323,12,59.39),
       (18346,22,7.79),
       (18347,3,68.90),
       (18376,6,51.24),
       (18432,8,22.73),
       (18468,6,115.06),
       (18469,9,53.96),
       (18479,12,24.08),
       (18552,12,36.31),
       (18610,45,136.79),
       (18626,20,104.20),
       (18671,21,78.40),
       (18673,6,81.12),
       (18778,6,85.19),
       (18788,4,60.75),
       (18798,4,13.22),
       (18818,23,6.43),
       (18838,18,6.43),
       (18888,51,62.11),
       (18891,9,77.04),
       (18967,9,78.40),
       (19001,4,100.13),
       (19020,6,120.50),
       (19029,6,43.09),
       (19033,65,43.09),
       (19045,4,106.92),
       (19093,45,106.92),
       (19239,16,94.70),
       (19248,39,77.04),
       (19253,80,83.83),
       (19310,6,15.94),
       (19339,16,17.29),
       (19367,16,127.28),
       (19369,21,90.62),
       (19468,3,3.72),
       (19475,4,45.81),
       (19477,24,85.19),
       (19482,12,108.27),
       (19524,10,44.45),
       (19605,9,62.11),
       (19624,32,11.86),
       (19641,20,117.78),
       (19660,24,89.26),
       (19688,20,98.77),
       (19762,30,5.07),
       (19768,51,36.31),
       (19806,3,37.66),
       (19808,16,117.78),
       (19812,5,20.01),
       (19821,9,3.72),
       (19904,6,108.27),
       (20010,45,124.57),
       (20029,6,134.07),
       (20044,22,105.56),
       (20061,18,15.94),
       (20084,3,3.72),
       (20110,18,123.21),
       (20182,43,70.25),
       (20313,4,79.76),
       (20329,12,75.68),
       (20349,16,51.24),
       (20372,26,52.60),
       (20390,27,81.12),
       (20399,10,63.46),
       (20401,11,62.11),
       (20490,18,5.07),
       (20524,24,113.71),
       (20543,4,26.80),
       (20562,7,112.35),
       (20633,35,131.36),
       (20660,10,119.14),
       (20662,8,22.73),
       (20684,6,110.99),
       (20688,6,11.86),
       (20716,6,43.09),
       (20729,12,32.23),
       (20730,28,41.74),
       (20776,6,100.13),
       (20805,12,130.00),
       (20825,26,82.47),
       (20845,9,104.20),
       (20853,57,91.98),
       (20861,15,24.08),
       (20874,4,34.95),
       (20902,12,10.51),
       (20904,9,117.78),
       (20943,45,83.83),
       (20954,6,26.80),
       (20984,8,102.84),
       (21016,16,86.55),
       (21103,27,109.63),
       (21117,16,62.11),
       (21170,54,21.37),
       (21228,8,96.05),
       (21263,12,39.02),
       (21264,18,89.26),
       (21266,4,29.52),
       (21309,10,123.21),
       (21345,3,39.02),
       (21350,15,132.72),
       (21358,6,49.88),
       (21382,6,134.07),
       (21469,40,70.25),
       (21473,33,98.77),
       (21482,16,101.48),
       (21496,29,117.78),
       (21505,6,29.52),
       (21550,21,98.77),
       (21574,20,105.56),
       (21644,4,15.94),
       (21654,12,7.79),
       (21722,7,117.78),
       (21729,10,17.29),
       (21771,6,83.83),
       (21773,6,56.67),
       (21810,10,66.18),
       (21811,6,134.07),
       (21901,8,102.84),
       (21912,8,132.72),
       (21923,6,121.85),
       (22000,6,7.79),
       (22083,24,79.76),
       (22091,9,102.84),
       (22093,4,30.87),
       (22180,12,26.80),
       (22190,8,32.23),
       (22231,3,15.94),
       (22268,15,43.09),
       (22280,57,101.48),
       (22281,28,68.90),
       (22320,6,44.45),
       (22376,3,70.25),
       (22391,15,56.67),
       (22412,21,102.84),
       (22501,7,59.39),
       (22563,9,18.65),
       (22603,32,29.52),
       (22605,12,68.90),
       (22632,12,37.66),
       (22673,26,124.57),
       (22679,4,45.81),
       (22692,30,128.64),
       (22696,6,5.07),
       (22702,6,15.94),
       (22705,17,53.96),
       (22748,12,39.02),
       (22755,10,90.62),
       (22817,7,24.08),
       (22865,29,33.59),
       (22902,12,55.32),
       (22922,9,41.74),
       (22930,6,89.26),
       (22949,30,120.50),
       (23018,10,121.85),
       (23066,8,49.88),
       (23102,4,51.24),
       (23144,11,97.41),
       (23149,61,71.61),
       (23161,70,108.27),
       (23191,27,81.12),
       (23213,12,13.22),
       (23270,6,39.02),
       (23289,34,6.43),
       (23303,21,55.32),
       (23336,3,5.07),
       (23365,5,18.65),
       (23377,4,125.93),
       (23381,31,125.93),
       (23410,18,21.37),
       (23463,16,66.18),
       (23478,8,81.12),
       (23484,14,44.45),
       (23503,8,77.04),
       (23526,23,83.83),
       (23556,6,14.58),
       (23570,14,101.48),
       (23628,3,79.76),
       (23694,6,79.76),
       (23795,8,85.19),
       (23812,8,128.64),
       (23816,14,37.66),
       (23970,29,109.63),
       (24009,39,100.13),
       (24027,18,96.05),
       (24053,6,102.84),
       (24076,18,32.23),
       (24111,9,131.36),
       (24161,12,20.01),
       (24174,40,124.57),
       (24185,59,113.71),
       (24206,5,29.52),
       (24260,10,47.17),
       (24309,47,28.16),
       (24327,16,34.95),
       (24338,10,127.28),
       (24345,21,11.86),
       (24410,7,89.26),
       (24431,3,119.14),
       (24437,38,45.81),
       (24484,6,125.93),
       (24505,18,119.14),
       (24518,9,60.75),
       (24547,4,116.42),
       (24558,16,117.78),
       (24562,14,94.70),
       (24667,18,117.78),
       (24693,9,101.48),
       (24739,28,34.95),
       (24768,27,70.25),
       (24801,24,132.72),
       (24834,5,78.40),
       (24855,9,32.23),
       (24865,3,98.77),
       (24914,6,125.93),
       (24926,45,60.75),
       (24954,8,44.45),
       (24969,39,101.48)
go

Update tTMPAtualizaEstoque 
   Set nQuantidade += 10 , 
       mValor *= 1.10

/*
Para criarmos um parâmetro de valor de tabela, temos que ter um dos
parâmetro da procedure para receber uma tabela.

Na declaração dos parâmetros de uma procedure, temos que especificar 
o nome do parâmetro, e tipo de dados, o valor padrão e a direção.

Para o parâmetro de valor de tabela, utilizaremos três palavras chaves:
1. O nome do parâmetro
2. O tipo de dado
3. Palavra chave READONLY, obrigatório. 
*/


/*
1. O nome do parâmetro
*/

/*------------------------------------------------------------
Autor      : Wolney M. Maia
Objeto     : stp_AtualizaEstoque 
Objetivo   : Atualiza a quantidade e valor de vários livros para uma
             determinada loja. 

Histórico:        
Autor                  IDBug Data       Descrição        
---------------------- ----- ---------- --------------------
Wolney M. Maia               01/01/2019 Criação da Procedure 
------------------------------------------------------------*/
Create or Alter Procedure stp_AtualizaEstoque 
@iidLoja int, 
@tAtualizaEstoque 
as
Begin
   Set nocount on 
End 
/*
*/
go


/*
2. O tipo de dados

Como visto na aula "Criando um tipo de dado tabela" na seção "Tabelas Tempoárias",
o SQL Server não tem um tipo de dados nativo para tabela.

Devemos criar o tipo de dados no formato para receber os dados que
desejamos passar para a procedure. 

*/
use eBook
go

Create Type dtAtualizaEstoque 
As Table 
(   
   iIDLivro int not null,
   nQuantidade int not null,
   mValor smallmoney not null 
)
go

/*
Na definição da procedure, especificamos esse tipo de dado 
no parâmetro @tAtualizaEstoque e especificamos 
a palavra chave READONLY
*/

/*------------------------------------------------------------
Autor      : Wolney M. Maia
Objeto     : stp_AtualizaEstoque 
Objetivo   : Atualiza a quantidade e valor de vários livros para uma
             determinada loja. 

Histórico:        
Autor                  IDBug Data       Descrição        
---------------------- ----- ---------- --------------------
Wolney M. Maia               01/01/2019 Criação da Procedure 
------------------------------------------------------------*/
Create or Alter Procedure stp_AtualizaEstoque 
@iidLoja int, 
@tAtualizaEstoque dtAtualizaEstoque READONLY
as
Begin
   Set nocount on 
End 
/*
*/
go

/*
Agora vamos criar a procedure para atualizar a tabela 
tRELEstoque com base no parâmetro de valor de tabela  @tAtualizaEstoque
*/

/*------------------------------------------------------------
Autor      : Wolney M. Maia
Objeto     : stp_AtualizaEstoque 
Objetivo   : Atualiza a quantidade e valor de vários livros para uma
             determinada loja. 

Histórico:        
Autor                  IDBug Data       Descrição        
---------------------- ----- ---------- --------------------
Wolney M. Maia               01/01/2019 Criação da Procedure 
------------------------------------------------------------*/
Create or Alter Procedure stp_AtualizaEstoque 
@iidLoja int, 
@tAtualizaEstoque dtAtualizaEstoque READONLY
as
Begin

   Set nocount on 

   Declare @nRetorno int = 0 

   Begin Try

      Update tRELEstoque 
         Set nQuantidade += tAtualizaEstoque.nQuantidade ,
             mValor = tAtualizaEstoque.mValor 
        From tRELEstoque 
        Join @tAtualizaEstoque as tAtualizaEstoque
          on tRELEstoque.iIDLivro = tAtualizaEstoque.iIDLivro
       Where tRELEstoque.iIDLoja = @iidLoja
      
      if @@rowcount = 0
         Raiserror('Não houve livros para atualizar o estoque.',16,1)
       
   End Try 

   Begin Catch 

      Execute @nRetorno = stp_ManipulaErro

   End Catch 

   Return @nRetorno

End 
/*
*/
go

/*
Como o parâmetro de valor de tabela é definido como se fosse
uma variável, na execução da procedure, a passagem dos valores
de tabela deve ser feito também por uma variável. 

No caso, uma variável tabela visto na aula "Variável tipo tabela" 
na seção "Tabelas Temporárias"

*/


/*
Validando 
*/

Select count(1) , sum(mValor) from tRELEstoque where iIDLoja = 20 

-- Declare a variavel tabela igual ao tipo de dados tabela. 
Declare @tTMPItensEnviados dtAtualizaEstoque 

-- Inserir os dados enviados para essa variável 
Insert into @tTMPItensEnviados (iIDLivro,nQuantidade,mValor)
Select iIDLivro,nQuantidade,mValor from tTMPAtualizaEstoque 

Declare @iidLoja int = 20 
Declare @nStatus int 

execute @nStatus = stp_AtualizaEstoque  @iidLoja = @iidLoja ,
                                        @tAtualizaEstoque = @tTMPItensEnviados
Print @nStatus 

Select count(1) , sum(mValor) from tRELEstoque where iIDLoja = 20 


/*
*/

